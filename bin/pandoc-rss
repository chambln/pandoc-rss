#!/bin/sh

usage ()
{
    >&2 printf 'Usage: %s [OPTIONS] FILE...\n' "${0##*/}"
}

generate_feed_item ()
{
    input_file=$1
    shift
    if [ -n "${permalink_format-}" ]
    then
	filename=${input_file##*/}
	basename=${filename%.*}
	permalink=$(printf "$permalink_format" "$basename")
	set -- -V "permalink:$permalink" "$@"
    fi
    pandoc --template="$share/data/templates/item.xml" "$@" "$input_file"
}

while true
do
    case "$1" in
    -f|--permalink-format)
	permalink_format=${2-}
	case $permalink_format in
	    *%s*) ;;
	    *) >&2 echo 'Permalink format must contain ‘%s’'; exit 1
	esac
	shift 2
	;;
    -h|--help)
	usage
	exit
	;;
    --)
	shift
	break
	;;
    -*)
	>&2 printf 'No such option ‘%s’' "$1"
	exit 1
	;;
    *)
	break
    esac
done

share=${0%/*}/../share/pandoc-rss

for input_file do
    generate_feed_item "$input_file"
done
