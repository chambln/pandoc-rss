#!/bin/sh

get_metadata_value ()
{
    key=$1
    shift
    pandoc --template="$templates_dir/$key.value" "$@"
}

# Print the guid element for an input_file.
# e.g. guid_format=http://example.net/%s.html
#      input_file=path/to/fox-in-socks.md
#   => http://example.net/fox-in-socks.html
get_guid ()
{
    [ -n "${guid_format-}" ] || return 1
    input_file=$1
    shift
    filename=${input_file##*/}
    basename=${filename%.*}
    printf "$guid_format" "$basename"
}

get_date ()
{
    input_file=$1
    shift
    if date=$(get_metadata_value date "$input_file")
    then
	/usr/bin/date --utc --date "$date" +'%a, %d %b %Y %T +0000'
    fi
}

generate_feed_item ()
{
    input_file=$1
    shift

    if guid=$(get_guid "$input_file")
    then
	if $guid_is_perma_link
	then
	    set -- -V "guid:<guid isPermaLink=\"true\">$guid</guid>" "$@"
	else
	    set -- -V "guid:<guid isPermaLink=\"false\">$guid</guid>" "$@"
	fi
    fi

    if date=$(get_date "$input_file")
    then
	set -- -V "date:$date" "$@"
    fi

    pandoc --template="$item_template" "$@" "$input_file"
}

description_source=body
guid_is_perma_link=true
while getopts d:g:ph name
do
    case "$name" in
    d)
	description_source=$OPTARG
	case $description_source in
	body|description|subtitle|abstract|none) ;;
        *)
	    >&2 printf 'Invalid arg ‘%s’ for -%s option\n' "$OPTARG" "$name"
	    exit 1
	esac
	;;
    g)
	guid_format=$OPTARG
	;;
    p)
	guid_is_perma_link=false
	;;
    h)
	>&2 printf 'Usage: %s [OPTIONS] [FILE]...\n' "${0##*/}"
	exit
    esac
done
shift $((OPTIND - 1))

share=${0%/*}/../share/${0##*/}
templates_dir=$share/data/templates

item_template="$templates_dir/item-with-${description_source}.xml"

for input_file do
    generate_feed_item "$input_file"
done
