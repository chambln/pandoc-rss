#!/bin/sh

get_user_fullname_gecos ()
{
    while IFS=':' read -r user _ _ _ gecos _
    do
	if [ x"$user" = x"$LOGNAME" ]
	then
	    user_fullname="${gecos%%,*}"
	    [ -n "$user_fullname" ] || exit 1
	    printf %s\\n "$user_fullname"
	    return 0
	fi
    done < /etc/passwd
    return 1
}

get_user_fullname ()
{
    printf %s\\n "${NAME:-$(get_user_fullname_gecos)}"
}

get_webmaster ()
{
    [ -n "$EMAIL" ] || return 1
    printf '%s (%s)\n' "$EMAIL" "$(get_user_fullname)"
}

get_metadata_value ()
{
    key=$1
    shift
    value=$(pandoc --template="$templates_dir/$key.value" "$@")
    [ -n "$value" ] || return 1
    printf %s\\n "$value"
}

# Print the guid element for an input_file.
# e.g. guid_format=http://example.net/%s.html
#      input_file=path/to/fox-in-socks.md
#   => http://example.net/fox-in-socks.html
get_guid ()
{
    [ -n "${guid_format-}" ] || return 1
    input_file=$1
    shift
    filename=${input_file##*/}
    basename=${filename%.*}
    printf "$guid_format" "$basename"
}

get_date ()
{
    input_file=$1
    shift
    if date=$(get_metadata_value date "$input_file")
    then
	/usr/bin/date --utc --date "$date" +'%a, %d %b %Y %T +0000'
    fi
}

generate_feed_item ()
{
    input_file=$1
    shift

    if guid=$(get_guid "$input_file")
    then
	attribute=" isPermLink=\"$guid_is_perma_link\""
	set -- -V "guid:<guid${attribute-}>$guid</guid>" "$@"
    fi

    if date=$(get_date "$input_file")
    then
	set -- -V "date:$date" "$@"
    fi

    pandoc --template="$item_template" "$@" "$input_file"
}

generate_feed_items ()
{
    for input_file do
	generate_feed_item "$input_file"
    done
}

print_xml_element ()
{
    [ -n "$2" ] || return 1
    printf '<%s>%s</%s>\n' "$1" "$2" "$1"
}

generate_standalone_feed ()
{
    echo '<?xml version="1.0" encoding="UTF-8" ?>'
    echo '<rss version="2.0">'
    echo '<channel>'
    print_xml_element title "$channel_title"
    print_xml_element link "$channel_link"
    print_xml_element description "$channel_description"
    print_xml_element webMaster "$channel_webmaster"
    echo '<generator>Pandoc RSS</generator>'
    generate_feed_items "$@"
    echo '</channel>'
    echo '</rss>'
}

description_source=body
guid_is_perma_link=true
standalone=false
while getopts D:L:T:SW:d:g:hp name
do
    case "$name" in
    S)  standalone=true ;;
    T)  channel_title=$OPTARG ;;
    L)  channel_link=$OPTARG ;;
    D)  channel_description=$OPTARG ;;
    W)  channel_webmaster=$OPTARG ;;
    d)  description_source=$OPTARG
	case $description_source in
	body|description|subtitle|abstract|none) ;;
        *)
	    >&2 printf 'Invalid arg ‘%s’ for -%s option\n' "$OPTARG" "$name"
	    exit 1
	esac
	;;
    g)  guid_format=$OPTARG ;;
    h)  >&2 printf 'Usage: %s [OPTIONS] [FILE]...\n' "${0##*/}"; exit ;;
    p)  guid_is_perma_link=false ;;
    esac
done
shift $((OPTIND - 1))

share=${0%/*}/../share/${0##*/}
templates_dir=$share/data/templates

item_template="$templates_dir/item-with-${description_source}.xml"

if $standalone
then
    generate_standalone_feed "$@"
else
    generate_feed_items "$@"
fi
