#!/bin/sh

die() {
    >&2 printf '%s: %s\n' "${0##*/}" "$1"
    exit "${2:-1}"
}

while :; do
    case "$1" in
    -f|--format)
        format="$2"
        shift 2
        ;;
    -h|--help)
        die "Usage: ${0##*/} -f FORMAT FILE [FILE ...]"
        ;;
    --)
        shift
        break
        ;;
    -*)
        die "No such option ‘$1’"
        ;;
    *)
        break
        ;;
    esac
done

[ -n "$format" ] || die 'Please specify a format string.'

data_dir=${0%/*}/../share/pandoc-rss/data

for markup_file do
    date="$(pandoc --template="$data_dir/date.variable" "$markup_file")"
    date="$(date -u -d "$date" '+%a, %d %b %Y %T +0000')"
    filename=${markup_file##*/}
    basename=${filename%.*}
    linkprefix="$(printf "$format" "$basename")"
    pandoc \
      --template="$data_dir/item.xml" \
      -V "date:$date" \
      -V "linkprefix:$linkprefix" \
      "$markup_file"
done
